{% extends "base.html" %}

{% block title %}Browse Posts - Research Explorer{% endblock %}

{% block content %}
<h1>Browse Posts</h1>

<div class="card">
    <form class="filters" method="get">
        <select name="gender" onchange="this.form.submit()">
            <option value="">All Genders</option>
            {% for g in genders %}
            <option value="{{ g.poster_gender }}" {% if current_gender == g.poster_gender %}selected{% endif %}>
                {{ g.poster_gender }}
            </option>
            {% endfor %}
        </select>
        <select name="type" onchange="this.form.submit()">
            <option value="">All Types</option>
            {% for t in types %}
            <option value="{{ t.relationship_type }}" {% if current_type == t.relationship_type %}selected{% endif %}>
                {{ t.relationship_type }}
            </option>
            {% endfor %}
        </select>
        <span style="line-height: 38px; color: #666;">{{ total }} posts found</span>
    </form>

    <table>
        <tr>
            <th>Title</th>
            <th>Gender</th>
            <th>Type</th>
            <th>Comments</th>
        </tr>
        {% for post in posts %}
        <tr>
            <td>
                <a href="/post/{{ post.post_id }}">{{ post.title }}</a>
                <br><small style="color: #666;">{{ post.brief_situation_summary[:100] }}{% if post.brief_situation_summary|length > 100 %}...{% endif %}</small>
            </td>
            <td>
                <span class="badge badge-{{ post.poster_gender }}">{{ post.poster_gender }}</span>
                {% if post.gender_confidence %}
                <span class="confidence">{{ "%.0f"|format(post.gender_confidence * 100) }}%</span>
                {% endif %}
            </td>
            <td><span class="badge badge-{{ post.relationship_type }}">{{ post.relationship_type }}</span></td>
            <td>{{ post.comment_count }}</td>
        </tr>
        {% endfor %}
    </table>

    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?gender={{ current_gender }}&type={{ current_type }}&page={{ page - 1 }}">&laquo; Prev</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="current">{{ p }}</span>
            {% elif p <= 3 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="?gender={{ current_gender }}&type={{ current_type }}&page={{ p }}">{{ p }}</a>
            {% elif p == 4 or p == total_pages - 2 %}
            <span>...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="?gender={{ current_gender }}&type={{ current_type }}&page={{ page + 1 }}">Next &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
